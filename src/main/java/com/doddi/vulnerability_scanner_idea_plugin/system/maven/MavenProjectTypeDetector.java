package com.doddi.vulnerability_scanner_idea_plugin.system.maven;

import com.doddi.vulnerability_scanner_idea_plugin.config.ProjectConfigurationListener;
import com.doddi.vulnerability_scanner_idea_plugin.system.ProjectTypeDetector;
import com.intellij.openapi.application.ApplicationManager;
import com.intellij.openapi.module.Module;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.roots.ModuleRootManager;
import com.intellij.openapi.vfs.VirtualFile;
import org.jetbrains.idea.maven.project.MavenProjectsManager;

public class MavenProjectTypeDetector implements ProjectTypeDetector
{
  public static final String JAVA_TYPE = "Java Module";

  @Override
  public boolean detect(final Project project, final Module module) {
    for (VirtualFile root : ModuleRootManager.getInstance(module).getContentRoots()) {
      if (root.findChild("pom.xml") != null || root.findChild("build.gradle") != null) {
        return true;
      }
    }
    return false;
  }

  @Override
  public void start(final Project project) {
    final MavenProjectsManager mavenProjectsManager = MavenProjectsManager.getInstance(project);
    final MavenProjectListener listener = new MavenProjectListener(project);
    mavenProjectsManager.addManagerListener(listener);

    ApplicationManager.getApplication().getMessageBus().connect()
        .subscribe(ProjectConfigurationListener.TOPIC, listener::checkForUpdate);

    listener.checkForUpdate();
  }
}
