package com.doddi.vulnerability_scanner_idea_plugin.system.golang.gomod;

import java.io.IOException;
import java.util.HashSet;
import java.util.Set;

import org.sonatype.goodies.packageurl.PackageUrl;

import com.doddi.vulnerability_scanner_idea_plugin.entity.LibraryToScan;
import com.google.common.io.LineReader;
import com.intellij.openapi.diagnostic.Logger;

public class GomodWrappedParser
    implements GomodParser
{
  private static final Logger LOGGER = Logger.getInstance(GomodWrappedParser.class);

  private final LineReader reader;

  public GomodWrappedParser(final LineReader reader) {
    this.reader = reader;
  }

  @Override
  public Set<LibraryToScan> parse(final String currentLine) throws IOException {
    Set<LibraryToScan> libraries = new HashSet<>();

    String line = reader.readLine();
    while (line != null && !line.contains(")")) {
      final String[] tokens = line.split(" ");
      if (tokens.length < 2) {
        LOGGER.warn("Not enough tokens to parse requirement");
        return libraries;
      }

      String require = tokens[0].trim();
      String namespace = require.substring(0, require.lastIndexOf("/"));
      String name = require.substring(require.lastIndexOf("/") + 1).trim();
      String version = tokens[1];

      line = reader.readLine();

      final PackageUrl packageUrl = PackageUrl.builder()
          .type("golang")
          .namespace(namespace)
          .name(name)
          .version(version)
          .build();

      libraries.add(new LibraryToScan(packageUrl, null));
    }

    return libraries;
  }
}
