package com.doddi.vulnerability_scanner_idea_plugin.action;

import com.doddi.vulnerability_scanner_idea_plugin.VulnerabilityMessageProvider;
import com.doddi.vulnerability_scanner_idea_plugin.module.VulnerableComponent;
import com.doddi.vulnerability_scanner_idea_plugin.service.ScannerService;
import com.doddi.vulnerability_scanner_idea_plugin.service.VulnerabilityService;
import com.intellij.openapi.actionSystem.AnAction;
import com.intellij.openapi.actionSystem.AnActionEvent;
import com.intellij.openapi.components.ServiceManager;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.ui.Messages;
import org.jetbrains.annotations.NotNull;

import java.util.List;
import java.util.stream.Collectors;

public class PopupDialogueAction extends AnAction
{
  @Override
  public void update(@NotNull final AnActionEvent e) {
    final Project project = e.getProject();
    e.getPresentation().setEnabledAndVisible(project != null);
  }

  @Override
  public void actionPerformed(@NotNull final AnActionEvent event) {
    final VulnerabilityService vulnerabilityService = VulnerabilityService.getInstance();
    final ScannerService scannerService = ServiceManager.getServiceIfCreated(ScannerService.class);
    final List<VulnerableComponent> vulnerableComponents = vulnerabilityService.getVulnerableComponents()
            .entrySet().stream()
            .map(e -> e.getValue())
            .collect(Collectors.toList());
    String message = VulnerabilityMessageProvider.buildToolMessage(scannerService.getName(), scannerService.getUrl(), vulnerableComponents);

    Messages.showMessageDialog(event.getProject(), message, event.getPresentation().getDescription(), Messages.getInformationIcon());
  }
}
