package com.doddi.vulnerability_scanner_idea_plugin.action;

import java.util.ArrayList;
import java.util.List;

import com.doddi.vulnerability_scanner_idea_plugin.VulnerabilityMessageProvider;
import com.doddi.vulnerability_scanner_idea_plugin.entity.VulnerableComponent;
import com.doddi.vulnerability_scanner_idea_plugin.service.ScannerService;
import com.doddi.vulnerability_scanner_idea_plugin.service.VulnerabilityService;
import com.intellij.openapi.actionSystem.AnAction;
import com.intellij.openapi.actionSystem.AnActionEvent;
import com.intellij.openapi.components.ServiceManager;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.ui.Messages;
import org.jetbrains.annotations.NotNull;

public class PopupDialogueAction
    extends AnAction
{
  @Override
  public void update(@NotNull final AnActionEvent e) {
    final Project project = e.getProject();
    e.getPresentation().setEnabledAndVisible(project != null);
  }

  @Override
  public void actionPerformed(@NotNull final AnActionEvent event) {
    if (event.getProject() == null) {
      return;
    }

    final VulnerabilityService vulnerabilityService = ServiceManager
        .getServiceIfCreated(event.getProject(), VulnerabilityService.class);
    final ScannerService scannerService = ServiceManager.getServiceIfCreated(ScannerService.class);

    if (vulnerabilityService != null && scannerService != null) {
      final List<VulnerableComponent> vulnerableComponents = new ArrayList<>(
          vulnerabilityService.getVulnerableComponents()
              .values());
      String message = VulnerabilityMessageProvider
          .buildToolMessage(scannerService.getName(), scannerService.getUrl(), vulnerableComponents);

      Messages.showMessageDialog(event.getProject(), message, event.getPresentation().getDescription(),
          Messages.getInformationIcon());
    }
  }
}
