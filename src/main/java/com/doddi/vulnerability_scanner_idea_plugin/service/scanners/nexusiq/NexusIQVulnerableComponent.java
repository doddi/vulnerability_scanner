package com.doddi.vulnerability_scanner_idea_plugin.service.scanners.nexusiq;

import java.util.Arrays;
import java.util.Optional;

import org.sonatype.goodies.packageurl.PackageUrl;

import com.doddi.vulnerability_scanner_idea_plugin.entity.VulnerableComponent;
import com.doddi.vulnerability_scanner_idea_plugin.util.nexusiqclient.evaluation.ConstraintViolation;
import com.doddi.vulnerability_scanner_idea_plugin.util.nexusiqclient.evaluation.EvaluationResult;
import com.doddi.vulnerability_scanner_idea_plugin.util.nexusiqclient.evaluation.policy.PolicyViolation;
import com.doddi.vulnerability_scanner_idea_plugin.util.nexusiqclient.evaluation.security.SecurityData;
import com.doddi.vulnerability_scanner_idea_plugin.util.nexusiqclient.evaluation.security.SecurityIssue;
import com.doddi.vulnerability_scanner_idea_plugin.util.nexusiqclient.remediation.RemediationResponse;
import com.doddi.vulnerability_scanner_idea_plugin.util.nexusiqclient.remediation.VersionChange;

public class NexusIQVulnerableComponent
    extends VulnerableComponent<EvaluationResult>
{
  private RemediationResponse remediation;

  @Override
  public String buildPackageInformation(final String currentScannerName, final String currentScannerLink) {
    final StringBuffer stringBuffer = new StringBuffer();
    buildTitle(currentScannerName, currentScannerLink, stringBuffer);

    final EvaluationResult evaluationResult = this.getReports().get(0);
    final PolicyViolation[] policyViolations = evaluationResult.getPolicyData().getPolicyViolations();
    stringBuffer.append(String
        .format("<br><br><i>%s v%s</i> contains ", this.getPackageUrl().getName(), this.getPackageUrl().getVersion()));
    stringBuffer.append(String.format("<b>%d</b> ", policyViolations.length));
    stringBuffer.append(getPolicyString(policyViolations.length));

    if (policyViolations.length > 0) {
      stringBuffer.append("<br><br>")
          .append("<b>Remediation:</b><br>")
          .append(displayRemediation());
    }

    stringBuffer.append("<br><br><b>Policies:</b><ul>");
    for (PolicyViolation violation : policyViolations) {
      stringBuffer.append("<li>")
          .append(violation.getPolicyName())
          .append(": ")
          .append("<br>")
          .append("Constraints:<br>")
          .append(displayConstraintsViolated(violation, evaluationResult.getSecurityData()))
          .append("<br>");
      stringBuffer.append("</li>");
    }
    stringBuffer.append("</ul>");
    return stringBuffer.toString();
  }

  private String displayRemediation() {
    if (remediation == null || remediation.getRemediation() == null) {
      return "";
    }

    final VersionChange[] versionChanges = remediation.getRemediation().getVersionChanges();

    if (versionChanges.length > 0) {
      StringBuffer stringBuffer = new StringBuffer();
      for (VersionChange change : versionChanges) {
        stringBuffer.append(change.getType())
            .append(":")
            .append(getVersionToUpgrade(change))
            .append("<br>");
      }
      return stringBuffer.toString();
    }
    return "";
  }

  private String getVersionToUpgrade(final VersionChange change) {
    if (change.getData().getComponent().getPackageUrl() != null) {
      return "Version " + PackageUrl.parse(change.getData().getComponent().getPackageUrl()).getVersion();
    }
    return "none";
  }

  public String displayConstraintsViolated(final PolicyViolation violation,
                                           final SecurityData securityData)
  {
    StringBuffer stringBuffer = new StringBuffer();
    for (ConstraintViolation constraint : violation.getConstraintViolations()) {
      stringBuffer.append(constraint.getConstraintName());
      stringBuffer.append(maybeGetSecurityVulnerability(securityData, constraint));
      stringBuffer.append(", ");
    }
    return stringBuffer.substring(0, stringBuffer.length() - 2);
  }

  public String maybeGetSecurityVulnerability(final SecurityData securityData, final ConstraintViolation constraint) {
    if (constraint.getReasons()[0].getReason().startsWith("Found security vulnerability ")) {
      final String trimmedStart = constraint.getReasons()[0].getReason()
          .replace("Found security vulnerability ", "");
      final String[] split = trimmedStart.split(" ");

      final String security_ref = split[0];
      final Optional<SecurityIssue> securityIssue = Arrays.stream(securityData.getSecurityIssues())
          .filter(data -> data.getReference().equals(security_ref))
          .findFirst();

      if (securityIssue.isPresent()) {
        final String reason = constraint.getReasons()[0].getReason();
        return " - " +
            reason.replace(security_ref, "<a href=\"" + getUrl(securityIssue.get()) + "\">" + security_ref + "</a>");
      }
    }
    return "";
  }

  public String getUrl(final SecurityIssue securityIssue) {
    return securityIssue.getUrl() != null ? securityIssue.getUrl() : "www.sonatype.com";
  }

  private void buildTitle(String providerName, String provideUrl, StringBuffer stringBuffer) {
    stringBuffer.append("Vulnerability information Provided by: ");
    stringBuffer.append(buildLink(providerName, provideUrl));
  }

  private String buildLink(String title, String link) {
    return String.format("<a href=%s>%s</a>", link, title);
  }

  private String getPolicyString(int policies) {
    return policies == 1 ? "policy violation" : "policy violations";
  }

  @Override
  public int getSeverity() {
    int threatLevel = 0;
    final EvaluationResult evaluationResult = this.getReports().get(0);
    for (PolicyViolation result : evaluationResult.getPolicyData().getPolicyViolations()) {
      if (result.getThreatLevel() > threatLevel) {
        threatLevel = result.getThreatLevel();
      }
    }
    return threatLevel;
  }

  public void setRemediation(final RemediationResponse remediation) {
    this.remediation = remediation;
  }
}
