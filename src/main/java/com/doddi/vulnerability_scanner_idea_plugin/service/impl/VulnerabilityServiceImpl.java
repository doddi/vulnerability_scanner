package com.doddi.vulnerability_scanner_idea_plugin.service.impl;

import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import java.util.stream.Collectors;

import org.sonatype.goodies.packageurl.PackageUrl;

import com.doddi.vulnerability_scanner_idea_plugin.entity.LibraryToScan;
import com.doddi.vulnerability_scanner_idea_plugin.entity.VulnerableComponent;
import com.doddi.vulnerability_scanner_idea_plugin.service.ScannerService;
import com.doddi.vulnerability_scanner_idea_plugin.service.VulnerabilityService;
import com.doddi.vulnerability_scanner_idea_plugin.system.Populator;
import com.intellij.openapi.project.Project;
import org.jetbrains.annotations.NotNull;

public class VulnerabilityServiceImpl
    implements VulnerabilityService
{
  private Populator populator;

  @Override
  public void setPopulator(final Populator populator) {
    this.populator = populator;
  }

  @Override
  public void checkLibraries(final Project project, final Set<LibraryToScan> libraries) {
    final ScannerService scannerService = ScannerService.getInstance();
    final List<PackageUrl> componentsToScan = collectPackageUrls(libraries);
    final List<VulnerableComponent> vulnerableComponents = scannerService.scan(project, componentsToScan);

    populate(libraries, vulnerableComponents, populator);
  }

  private void populate(final Set<LibraryToScan> libraries,
                        final List<VulnerableComponent> vulnerableComponents,
                        final Populator populator) {
    populator.populate(libraries, vulnerableComponents);
  }

  @NotNull
  private List<PackageUrl> collectPackageUrls(final Set<LibraryToScan> libraries) {
    return libraries.stream()
        .map(LibraryToScan::getPackageUrl)
        .collect(Collectors.toList());
  }


  @Override
  public Optional<VulnerableComponent> isVulnerable(final String name) {
    return populator.isVulnerable(name);
  }

  @Override
  public Map<String, VulnerableComponent> getVulnerableComponents() {
    return this.populator.getVulnerableComponents();
  }
}
