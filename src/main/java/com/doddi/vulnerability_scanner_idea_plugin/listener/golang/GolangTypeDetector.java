package com.doddi.vulnerability_scanner_idea_plugin.listener.golang;

import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.IOException;
import java.util.HashSet;
import java.util.List;
import java.util.Locale;
import java.util.Set;

import org.sonatype.goodies.packageurl.PackageUrl;
import org.sonatype.goodies.packageurl.PackageUrlBuilder;

import com.doddi.vulnerability_scanner_idea_plugin.listener.ProjectTypeDetector;
import com.doddi.vulnerability_scanner_idea_plugin.module.LibraryToScan;
import com.doddi.vulnerability_scanner_idea_plugin.service.VulnerabilityService;
import com.intellij.openapi.module.Module;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.vfs.VirtualFileManager;
import com.intellij.openapi.vfs.newvfs.BulkFileListener;
import com.intellij.openapi.vfs.newvfs.events.VFileContentChangeEvent;
import com.intellij.openapi.vfs.newvfs.events.VFileEvent;
import com.opencsv.CSVParserBuilder;
import com.opencsv.CSVReader;
import com.opencsv.CSVReaderBuilder;
import com.opencsv.ICSVParser;
import com.opencsv.exceptions.CsvValidationException;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class GolangTypeDetector implements ProjectTypeDetector {

    public static final Logger LOGGER = LoggerFactory.getLogger(ProjectTypeDetector.class);

    public static final String GOLANG_TYPE = "Golang";

    @Override
    public String getType() {
        return GOLANG_TYPE;
    }

    @Override
    public boolean detect(final Project project, final Module module) {
        return VirtualFileManager.getInstance()
                .findFileByUrl("file://" + project.getPresentableUrl() + "/go.sum") != null;
    }

    @Override
    public void start(final Project project) {
        VulnerabilityService.getInstance().setPopulator(new GolangPopulator());

        project.getMessageBus().connect().subscribe(VirtualFileManager.VFS_CHANGES, new BulkFileListener() {
            @Override
            public void after(@NotNull final List<? extends VFileEvent> events) {
                for (VFileEvent event : events) {
                    if (event.getFile().getPresentableUrl().equals(project.getPresentableUrl() + "/go.sum") && event instanceof VFileContentChangeEvent) {
                        scanProject(project);
                    }
                }
            }
        });

        scanProject(project);
    }

    private void scanProject(Project project) {
        Set<LibraryToScan> dependencies = getDependencies(project.getPresentableUrl() + "/go.sum");
        final VulnerabilityService vulnerabilityService = VulnerabilityService.getInstance();
        vulnerabilityService.checkLibraries(dependencies);
    }

    private Set<LibraryToScan> getDependencies(String fileName) {
        Set<LibraryToScan> libraryToScans = new HashSet<>();

        try(CSVReader reader = createCvsReader(fileName)) {
            String[] record;
            while ((record = reader.readNext()) != null) {
                int index = record[0].lastIndexOf('/');
                if (index != -1) {
                    String namespace = record[0].substring(0, index);
                    String name = record[0].substring(index + 1);
                    String version = record[1];

                    if (!version.endsWith("/go.mod")) {
                        PackageUrl packageUrl = new PackageUrlBuilder()
                                .type("golang")
                                .namespace(namespace)
                                .name(name)
                                .version(version.replace("/go.mod", ""))
                                .build();
                        libraryToScans.add(new LibraryToScan(packageUrl, null));
                    }
                }
            }
        } catch (IOException | CsvValidationException e) {
            LOGGER.error("Unable to get dependencies", e.getCause());
        }
        return libraryToScans;
    }

    private CSVReader createCvsReader(final String filename) throws FileNotFoundException {
        return new CSVReaderBuilder(new FileReader(filename))
                .withCSVParser(new CSVParserBuilder()
                        .withSeparator(' ')
                        .withQuoteChar(ICSVParser.DEFAULT_QUOTE_CHARACTER)
                        .withEscapeChar(ICSVParser.DEFAULT_ESCAPE_CHARACTER)
                        .withStrictQuotes(ICSVParser.DEFAULT_STRICT_QUOTES)
                        .withIgnoreLeadingWhiteSpace(ICSVParser.DEFAULT_IGNORE_LEADING_WHITESPACE)
                        .withIgnoreQuotations(ICSVParser.DEFAULT_IGNORE_QUOTATIONS)
                        .withFieldAsNull(ICSVParser.DEFAULT_NULL_FIELD_INDICATOR)
                        .withErrorLocale(Locale.getDefault())
                        .build())
                .build();
    }
}
