package com.doddi.vulnerability_scanner_idea_plugin.config;

import com.google.common.base.Strings;
import com.intellij.ide.passwordSafe.PasswordSafe;
import com.intellij.ide.passwordSafe.PasswordSafeException;
import com.intellij.openapi.components.PersistentStateComponent;
import com.intellij.openapi.components.ServiceManager;
import com.intellij.openapi.components.State;
import com.intellij.openapi.components.Storage;
import com.intellij.openapi.diagnostic.Logger;
import com.intellij.util.xmlb.XmlSerializerUtil;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;

@State(
    name = "Vulnerability.Scanner.ProjectSettings",
    storages = {@Storage(value = "vulnerability_scanner.xml")}
)
public class ApplicationSettings
    implements PersistentStateComponent<ApplicationConfiguration>
{
  private final static Logger LOGGER = Logger.getInstance(ApplicationSettings.class);

  public static final String PASSWORD_KEY = "Vulnerability.Scanner.Password";

  private ApplicationConfiguration configuration;

  public static ApplicationSettings getInstance() {
    return ServiceManager.getService(ApplicationSettings.class);
  }

  public ApplicationSettings() {
    this.configuration = new ApplicationConfiguration();
    this.configuration.setScannerType(ApplicationConfiguration.DEFAULT_SCANNER);
  }

  @Nullable
  @Override
  public ApplicationConfiguration getState() {
    return configuration;
  }

  @Override
  public void loadState(@NotNull final ApplicationConfiguration state) {
    XmlSerializerUtil.copyBean(state, configuration);
  }

  public void setConfiguration(final ApplicationConfiguration applicationConfiguration) {
    configuration = applicationConfiguration;
    storePassword(applicationConfiguration.getPassword());
  }

  private void storePassword(final String password) {
    try {
      PasswordSafe.getInstance().storePassword(null, ProjectSettings.class, PASSWORD_KEY, password);
    }
    catch (PasswordSafeException e) {
      LOGGER.error("Failed to store password", e);
    }
  }

  private String readPassword() {
    try {
      return Strings.nullToEmpty(PasswordSafe.getInstance().getPassword(null, ProjectSettings.class, PASSWORD_KEY));
    }
    catch (PasswordSafeException e) {
      LOGGER.error("Failed to read password", e);
      return "";
    }
  }

  public boolean isConfigured() {
    return this.configuration.getScannerType() != null;
  }

  public boolean useAuthentication() {
    return !Strings.isNullOrEmpty(this.configuration.getUsername()) && !Strings.isNullOrEmpty(readPassword());
  }

  public ApplicationConfiguration getStateWithPassword() {
    if (useAuthentication()) {
      this.configuration.setPassword(readPassword());
    }
    return configuration;
  }
}
