package com.doddi.vulnerability_scanner_idea_plugin.config;

import java.awt.event.ItemEvent;

import javax.swing.*;

import com.intellij.openapi.project.Project;
import com.intellij.openapi.ui.ComboBox;
import com.intellij.ui.components.JBPasswordField;
import com.intellij.ui.components.JBTextField;

public class ProjectSettingsPanel
{
  private final ProjectSettings projectSettings;

  private final ApplicationSettings applicationSettings;

  private JPanel panel;

  private ComboBox comboMode;

  private JBTextField txtUsername;

  private JBPasswordField txtPassword;

  private JBTextField txtUrl;

  private JLabel lblUrl;

  private ModeTypeComboBoxModel modeTypeComboBoxModel = new ModeTypeComboBoxModel();

  public ProjectSettingsPanel(final Project project,
                              final ProjectSettings projectSettings,
                              final ApplicationSettings applicationSettings) {
    this.projectSettings = projectSettings;
    this.applicationSettings = applicationSettings;

    comboMode.setModel(modeTypeComboBoxModel);
    modeTypeComboBoxModel.addElement(ModeType.OSSI);
    modeTypeComboBoxModel.addElement(ModeType.NEXUS_IQ);
    comboMode.setEnabled(true);

    comboMode.addItemListener(event -> {
      if (event.getStateChange() == ItemEvent.SELECTED) {
        final ModeType selectedMode = (ModeType) event.getItem();
        showNexusIQMode(!selectedMode.equals(ModeType.OSSI));
      }
    });

    if (this.projectSettings.isConfigured()) {
      setProjectConfiguration(projectSettings.getState());
    }

    if (this.applicationSettings.isConfigured()) {
      setApplicationConfiguration(applicationSettings.getStateWithPassword());
    }

    showNexusIQMode(false);
    initialiseSettingsPanel();
  }

  private void showNexusIQMode(final boolean enabled) {
    txtUrl.setVisible(enabled);
    lblUrl.setVisible(enabled);
  }

  private void initialiseSettingsPanel() {
    txtUsername.getEmptyText().setText("Enter username for more detailed vulnerability info");
    txtPassword.getEmptyText().setText("Enter password for more detailed vulnerability info");
    txtUrl.getEmptyText().setText("Provide Url to your Nexus IQ Server instance");
  }

  public JComponent getComponent() {
    return panel;
  }

  public ProjectConfiguration getProjectConfiguration() {
    final ProjectConfiguration configuration = new ProjectConfiguration();
    return configuration;
  }

  public void setProjectConfiguration(final ProjectConfiguration projectConfiguration) {
    //no op
  }

  public ApplicationConfiguration getApplicationConfiguration() {
    final ApplicationConfiguration configuration = new ApplicationConfiguration();

    final ModeType selectedItem = modeTypeComboBoxModel.getOrDefault();
    configuration.setModeType(selectedItem);
    configuration.setUsername(txtUsername.getText());
    if (txtPassword.getPassword().length > 0) {
      configuration.setPassword(new String(txtPassword.getPassword()));
    }
    if (selectedItem.equals(ModeType.NEXUS_IQ)) {
      configuration.setServerUrl(txtUrl.getText());
    }
    return configuration;
  }

  public void setApplicationConfiguration(final ApplicationConfiguration configuration) {
    this.comboMode.setSelectedItem(configuration.getModeType());
    this.txtUsername.setText(configuration.getUsername());
    this.txtPassword.setText(configuration.getPassword());
  }
}
