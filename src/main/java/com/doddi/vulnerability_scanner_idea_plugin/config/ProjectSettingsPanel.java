package com.doddi.vulnerability_scanner_idea_plugin.config;

import java.awt.event.ItemEvent;
import java.util.List;

import javax.swing.*;

import com.doddi.vulnerability_scanner_idea_plugin.util.nexusiqclient.NexusIQClient;
import com.intellij.openapi.application.ApplicationManager;
import com.intellij.openapi.diagnostic.Logger;
import com.intellij.openapi.progress.ProgressIndicator;
import com.intellij.openapi.progress.ProgressManager;
import com.intellij.openapi.progress.Task;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.ui.ComboBox;
import com.intellij.ui.components.JBPasswordField;
import com.intellij.ui.components.JBTextField;
import org.jetbrains.annotations.NotNull;

public class ProjectSettingsPanel
{
  public static final Logger LOGGER = Logger.getInstance(ProjectSettingsPanel.class);

  private Project project;

  private final ProjectSettings projectSettings;

  private final ApplicationSettings applicationSettings;

  private JPanel panel;

  private ComboBox comboMode;

  private ScannerTypeComboBoxModel scannerTypeComboBoxModel = new ScannerTypeComboBoxModel();

  private ScannerTypeListCellRenderer scannerTypeListCellRenderer = new ScannerTypeListCellRenderer();

  private JBTextField txtUsername;

  private JBPasswordField txtPassword;

  private JBTextField txtUrl;

  private JLabel lblUrl;

  private ComboBox comboAppId;

  private JLabel lblAppId;

  private JLabel lblUsername;

  private JLabel lblPassword;

  private JButton btnConnect;

  private JCheckBox chkLow;

  private JCheckBox chkMedium;

  private JCheckBox chkHigh;

  private JLabel lblThreats;

  private AppIdComboBoxModel appIdComboBoxModel = new AppIdComboBoxModel();

  public ProjectSettingsPanel(final Project project,
                              final ProjectSettings projectSettings,
                              final ApplicationSettings applicationSettings)
  {
    this.project = project;
    this.projectSettings = projectSettings;
    this.applicationSettings = applicationSettings;

    scannerTypeComboBoxModel = getAvailableScanners();
    comboMode.setModel(scannerTypeComboBoxModel);
    comboMode.setRenderer(scannerTypeListCellRenderer);
    comboMode.setEnabled(true);
    comboMode.addItemListener(event -> {
      if (ItemEvent.SELECTED == event.getStateChange()) {
        final UIConfiguration uiConfig = (UIConfiguration) event.getItem();
        showAppId(uiConfig.hasAppId());
        showRemoteUrl(uiConfig.hasRemoteUrl());
        showAuth(uiConfig.hasPassword(), uiConfig.passwordName(), uiConfig.hasUsername(), uiConfig.prefillUsername());
        showThreatLevel(uiConfig.hasThreatLevel());
      }
    });

    appIdComboBoxModel.addElement("None");
    comboAppId.setModel(appIdComboBoxModel);
    comboAppId.setEnabled(true);


    if (this.projectSettings.isConfigured()) {
      setProjectConfiguration(projectSettings.getState());
    }

    if (this.applicationSettings.isConfigured()) {
      setApplicationConfiguration(applicationSettings.getStateWithPassword());
    }

    final UIConfiguration selectedItem = (UIConfiguration) scannerTypeComboBoxModel.getSelectedItem();
    showAuth(selectedItem.hasPassword(), selectedItem.passwordName(), selectedItem.hasUsername(),
        selectedItem.prefillUsername());
    showAppId(selectedItem.hasAppId());

    initialiseSettingsPanel();
  }

  private void showThreatLevel(final boolean enabled) {
    lblThreats.setVisible(enabled);
    chkLow.setVisible(enabled);
    chkMedium.setVisible(enabled);
    chkHigh.setVisible(enabled);
  }

  public void showRemoteUrl(final boolean enabled) {
    txtUrl.setText("");
    txtUrl.setVisible(enabled);
    lblUrl.setVisible(enabled);
    btnConnect.setVisible(enabled);
  }

  private ScannerTypeComboBoxModel getAvailableScanners() {
    ScannerTypeComboBoxModel model = new ScannerTypeComboBoxModel();
    ApplicationSettings.getScanners().forEach((k, v) -> model.addElement(v));
    return model;
  }

  private void showAuth(final boolean hasPassword,
                        final String passwordText,
                        final boolean hasUsername,
                        final String prefillUsername)
  {
    lblUsername.setVisible(hasUsername);
    txtUsername.setVisible(hasUsername);
    if (!prefillUsername.isEmpty()) {
      txtUsername.setText(prefillUsername);
    }
    else {
      txtUsername.setText("");
    }
    txtPassword.setText("");
    lblPassword.setVisible(hasPassword);
    lblPassword.setText(passwordText);
    txtPassword.setVisible(hasPassword);
  }

  private void showAppId(final boolean enabled) {
    lblAppId.setVisible(enabled);
    comboAppId.setVisible(enabled);
    resetAppIdComboBox();
  }

  private void initialiseSettingsPanel() {
    txtUsername.getEmptyText().setText("Enter username for more detailed vulnerability info");
    txtPassword.getEmptyText().setText("Enter password for more detailed vulnerability info");
    txtUrl.getEmptyText().setText("Provide Url to your Nexus IQ Server instance");

    btnConnect.addActionListener(e -> {
      btnConnect.setEnabled(false);
      comboAppId.setEnabled(false);

      ProgressManager.getInstance().run(new ConnectTask());
    });
  }

  public JComponent getComponent() {
    return panel;
  }

  public ProjectConfiguration getProjectConfiguration() {
    final ProjectConfiguration configuration = new ProjectConfiguration();
    configuration.setApplicationId((String) this.appIdComboBoxModel.getSelectedItem());
    return configuration;
  }

  public void setProjectConfiguration(final ProjectConfiguration configuration) {
    final UIConfiguration selectedItem = scannerTypeComboBoxModel.getOrDefault();
    if (selectedItem.hasAppId()) {
      this.appIdComboBoxModel.setSelectedItem(configuration.getApplicationId());
    }
  }

  public ApplicationConfiguration getApplicationConfiguration() {
    final ApplicationConfiguration configuration = new ApplicationConfiguration();

    final UIConfiguration selectedItem = scannerTypeComboBoxModel.getOrDefault();
    configuration.setScannerConfigName(selectedItem.name());
    configuration.setUsername(txtUsername.getText());
    if (txtPassword.getPassword().length > 0) {
      configuration.setPassword(new String(txtPassword.getPassword()));
    }
    if (selectedItem.hasRemoteUrl()) {
      String url = txtUrl.getText();
      if (url.endsWith("/")) {
        url = url.substring(0, url.length() - 1);
      }
      configuration.setServerUrl(url);
    }

    configuration.setThreatLowEnabled(chkLow.isSelected());
    configuration.setThreatMediumEnabled(chkMedium.isSelected());
    configuration.setThreatHighEnabled(chkHigh.isSelected());
    return configuration;
  }

  public void setApplicationConfiguration(final ApplicationConfiguration configuration) {
    scannerTypeComboBoxModel
        .setSelectedItem(ApplicationSettings.getScannerConfigOrDefault(configuration.getScannerConfigName()));
    this.txtUsername.setText(configuration.getUsername());
    this.txtPassword.setText(configuration.getPassword());
    this.txtUrl.setText(configuration.getServerUrl());

    chkLow.setSelected(configuration.isThreatLowEnabled());
    chkMedium.setSelected(configuration.isThreatMediumEnabled());
    chkHigh.setSelected(configuration.isThreatHighEnabled());
  }

  private class ConnectTask
      extends Task.Modal
  {
    ConnectTask() {
      super(ProjectSettingsPanel.this.project, "Connection", false);
    }

    @Override
    public void run(@NotNull final ProgressIndicator progress) {
      progress.setIndeterminate(true);
      progress.pushState();
      try {
        progress.setText("Progress");
        ApplicationManager.getApplication().invokeLater(() -> {
          if (testAssetsUrl()) {
            reloadApplicationsList();
          }
        });
      }
      finally {
        // always re-enable the connect button
        ApplicationManager.getApplication().invokeLater(() -> btnConnect.setEnabled(true));

        progress.popState();
      }
    }
  }

  private void reloadApplicationsList() {
    final NexusIQClient nexusIQClient = new NexusIQClient(txtUrl.getText(), txtUsername.getText(),
        new String(txtPassword.getPassword()));
    final List<String> applicationIds = nexusIQClient.fetchApplicationIds();

    resetAppIdComboBox();
    applicationIds.forEach(appIdComboBoxModel::addElement);

    if (projectSettings.getState() != null &&
        projectSettings.getState().getApplicationId() != null &&
        appIdComboBoxModel.getIndexOf(projectSettings.getState().getApplicationId()) >= 0) {
      appIdComboBoxModel.setSelectedItem(projectSettings.getState().getApplicationId());
    }
    else {
      appIdComboBoxModel.setSelectedItem("None");
    }
    comboAppId.setEnabled(true);
  }

  private void resetAppIdComboBox() {
    appIdComboBoxModel.removeAllElements();
    appIdComboBoxModel.addElement("None");
  }

  private boolean testAssetsUrl() {
    final NexusIQClient nexusIQClient = new NexusIQClient(txtUrl.getText());
    return nexusIQClient.checkAssetsUrl();
  }

}
