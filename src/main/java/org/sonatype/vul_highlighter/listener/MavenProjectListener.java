package org.sonatype.vul_highlighter.listener;

import org.sonatype.vul_highlighter.service.VulnerabilityService;

import com.intellij.openapi.components.ServiceManager;
import com.intellij.openapi.project.Project;
import org.jetbrains.idea.maven.project.MavenProjectsManager;
import org.jetbrains.idea.maven.project.MavenProjectsManager.Listener;

public class MavenProjectListener implements Listener
{
  private final VulnerabilityService vulnerabilityService;

  private MavenProjectsManager mavenProjectsManager;

  private Project project;

  public MavenProjectListener(final Project project) {
    this.project = project;
    mavenProjectsManager = MavenProjectsManager.getInstance(project);
    vulnerabilityService = ServiceManager.getService(VulnerabilityService.class);
  }

  @Override
  public void activated() {
    mavenProjectsManager.getProjects().stream()
        .filter(mavenProjects -> mavenProjects.getDisplayName().equals(project.getName()))
        .findFirst()
        .ifPresent(p -> vulnerabilityService.scan(p.getDependencies()));
  }
}
