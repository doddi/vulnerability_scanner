package org.sonatype.vul_highlighter.listener.rust;

import java.util.Optional;

import org.sonatype.vul_highlighter.marker.ViolationMarker;
import org.sonatype.vul_highlighter.module.VulnerableComponent;
import org.sonatype.vul_highlighter.service.VulnerabilityService;

import com.intellij.codeInsight.daemon.LineMarkerInfo;
import com.intellij.psi.PsiElement;
import com.intellij.psi.impl.source.tree.LeafPsiElement;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class RustViolationMarker extends ViolationMarker
{
  public static final Logger LOGGER = LoggerFactory.getLogger(RustViolationMarker.class);

  @Override
  public LineMarkerInfo getLineMarkerInfo(@NotNull final PsiElement element) {
    if (element instanceof LeafPsiElement) {
      if (((LeafPsiElement) element).getElementType().toString().equals("use")) {
        final String use = element.getNextSibling().getNextSibling().getNode().getText();
        final String[] split = use.split("::");

        final Optional<VulnerableComponent> vulnerable = VulnerabilityService.getInstance()
            .isVulnerable(split[0]);

        if (vulnerable.isPresent()) {
          LOGGER.info("Vulnerabilities found for {}", use);
          return markVulnerable(element, vulnerable);
        }
      }

    }
    return null;
  }
}
