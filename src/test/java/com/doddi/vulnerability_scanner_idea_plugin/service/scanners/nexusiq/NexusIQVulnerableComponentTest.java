package com.doddi.vulnerability_scanner_idea_plugin.service.scanners.nexusiq;

import java.io.InputStream;
import java.io.InputStreamReader;

import org.sonatype.goodies.packageurl.PackageUrl;

import com.doddi.vulnerability_scanner_idea_plugin.util.nexusiqclient.evaluation.EvaluationResult;
import com.doddi.vulnerability_scanner_idea_plugin.util.nexusiqclient.evaluation.EvaluationResults;
import com.google.common.collect.ImmutableList;
import com.google.gson.Gson;
import org.junit.Test;

import static org.junit.Assert.assertEquals;

public class NexusIQVulnerableComponentTest
{
  private final Gson gson = new Gson();

  public void setupViolation(final String file, final int component) {
    final InputStream resourceAsStream = this.getClass().getResourceAsStream(file);
    final InputStreamReader streamReader = new InputStreamReader(resourceAsStream);

    final EvaluationResults evaluationResults = gson.fromJson(streamReader, EvaluationResults.class);
    final EvaluationResult result = evaluationResults.getResults()[component];

    underTest.setPackageUrl(PackageUrl.parse(result.getComponent().getPackageUrl()));
    underTest.setReports(ImmutableList.of(result));
  }

  private NexusIQVulnerableComponent underTest = new NexusIQVulnerableComponent();

  @Test
  public void noPolicyViolations() {
    setupViolation("no_policies.json", 0);

    final String packageInformation = underTest.buildPackageInformation("scannerName", "scannerLink");

    assertEquals("Vulnerability information Provided by: <a href=scannerLink>scannerName</a>\n" +
        "\n" +
        "<i>pkg:maven/commons-cli/commons-cli@1.3.1?type=jar</i>: contains <b>0</b> policy violations\n" +
        "\n" +
        "<ul></ul>", packageInformation);
  }

  @Test
  public void singleArchitectureViolation() {
    setupViolation("architecture_policy.json", 0);

    final String packageInformation = underTest.buildPackageInformation("scannerName", "scannerLink");

    assertEquals("Vulnerability information Provided by: <a href=scannerLink>scannerName</a>\n" +
        "\n" +
        "<i>pkg:maven/commons-collections/commons-collections@3.2.1?type=jar</i>: contains <b>1</b> policy violation\n" +
        "\n" +
        "<ul><li>Architecture-Quality: Version is old</li></ul>", packageInformation);
  }

  @Test
  public void multipleArchitectureViolation() {
    setupViolation("architecture_policy.json", 1);

    final String packageInformation = underTest.buildPackageInformation("scannerName", "scannerLink");

    assertEquals("Vulnerability information Provided by: <a href=scannerLink>scannerName</a>\n" +
        "\n" +
        "<i>pkg:maven/commons-collections/commons-collections@3.2.1?type=jar</i>: contains <b>1</b> policy violation\n" +
        "\n" +
        "<ul><li>Architecture-Quality: Version is old, Version is stale</li></ul>", packageInformation);
  }

  @Test
  public void singleSecurityPolicy() {
    setupViolation("security_policy.json", 0);

    final String packageInformation = underTest.buildPackageInformation("scannerName", "scannerLink");

    assertEquals("Vulnerability information Provided by: <a href=scannerLink>scannerName</a>\n" +
            "\n" +
            "<i>pkg:maven/commons-collections/commons-collections@3.2.1?type=jar</i>: contains <b>2</b> policy violations\n" +
            "\n" +
            "<ul><li>Security-Critical: Critical risk CVSS score - Found security vulnerability <a href=\"http://www.sonatype.com\">sonatype-2015-0002</a> with severity >= 9 (severity = 9.0)</li><li>Architecture-Quality: Version is old</li></ul>",
        packageInformation);
  }
}